<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>マルコフ連鎖チャット</title>
<style>
body { font-family: sans-serif; max-width: 700px; margin: 2em auto; }
#chat { border: 1px solid #ccc; padding: 1em; height: 400px; overflow-y: auto; background: #f9f9f9; }
.user { color: white; background: #007bff; padding: 0.5em; border-radius: 5px; margin: 0.5em 0; max-width: 80%; }
.bot { color: black; background: #e0e0e0; padding: 0.5em; border-radius: 5px; margin: 0.5em 0; max-width: 80%; }
input, button { padding: 0.5em; font-size: 1em; margin-top: 0.5em; width: 80%; }
</style>
</head>
<body>

<h2>マルコフ連鎖チャット（Worker + 外部テキスト）</h2>

<input type="text" id="userInput" placeholder="ここに文字列を入力">
<button onclick="sendMessage()">送信</button>

<div id="chat"></div>

<script>
const chatDiv = document.getElementById('chat');
let worker;

// Worker 初期化とテキスト読み込み
async function initWorker() {
  // Worker 作成
  worker = new Worker('worker.js');

  worker.onmessage = function(e) {
    const { type, msg } = e.data;
    if(type === 'log') {
      console.log('Worker:', msg);
    } else if(type === 'result') {
      appendChat('bot', msg);
    }
  };

  // テキストデータ fetch
  const response = await fetch('data.txt');
  const text = await response.text();

  worker.postMessage({ type: 'init', text: text });
}

function sendMessage() {
  const input = document.getElementById('userInput').value.trim();
  if (!input) return;
  appendChat('user', input);
  document.getElementById('userInput').value = '';
  worker.postMessage({ type: 'generate', input: input });
}

function appendChat(role, text) {
  const div = document.createElement('div');
  div.className = role;
  div.innerText = text;
  chatDiv.appendChild(div);
  chatDiv.scrollTop = chatDiv.scrollHeight;
}

// ページ読み込みで Worker 初期化
initWorker();
</script>

</body>
</html>
